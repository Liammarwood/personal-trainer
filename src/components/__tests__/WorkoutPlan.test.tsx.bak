import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import WorkoutPlan from '../../components/WorkoutPlan';
import type { Exercise } from '../../types';

// Mock contexts
const mockStartExercise = vi.fn();
const mockStopExercise = vi.fn();
const mockClearWorkoutPlan = vi.fn();
const mockTrackVideoFile = vi.fn();
const mockRemoveExerciseFromPlan = vi.fn();
const mockSetMultipleExercisesToWorkoutPlan = vi.fn();

const mockUseWorkout = vi.fn();
const mockUseSettings = vi.fn();

vi.mock('../../context/WorkoutContext', () => ({
  useWorkout: () => mockUseWorkout(),
}));

vi.mock('../../context/SettingsContext', () => ({
  useSettings: () => mockUseSettings(),
}));

const mockExercises: Exercise[] = [
  { id: 'push-up', name: 'Push-up', description: 'Standard push-up' },
  { id: 'squat', name: 'Squat', description: 'Bodyweight squat' },
  { id: 'plank', name: 'Plank', description: 'Plank hold' },
];

describe('WorkoutPlan Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    
    mockUseWorkout.mockReturnValue({
      workoutPlan: [],
      completedExercises: [],
      currentExerciseIndex: -1,
      startExercise: mockStartExercise,
      clearWorkoutPlan: mockClearWorkoutPlan,
      isTracking: false,
      exercises: mockExercises,
      currentExercise: null,
      stopExercise: mockStopExercise,
      loading: false,
      trackVideoFile: mockTrackVideoFile,
      selectedVideoFile: null,
      removeExerciseFromPlan: mockRemoveExerciseFromPlan,
      setMultipleExercisesToWorkoutPlan: mockSetMultipleExercisesToWorkoutPlan,
    });

    mockUseSettings.mockReturnValue({
      settings: {
        inputMode: 'webcam',
        showStatsOverlay: true,
        showRepQuality: false,
        soundEnabled: false,
        showAdvancedMode: false,
        clientSideProcessing: true,
      },
      updateSetting: vi.fn(),
    });
  });

  it('should render workout plan panel', () => {
    render(<WorkoutPlan />);
    
    expect(screen.getByText(/workout plan/i)).toBeInTheDocument();
  });

  it('should show exercise selector', () => {
    render(<WorkoutPlan />);
    
    const autocomplete = screen.getByRole('combobox');
    expect(autocomplete).toBeInTheDocument();
  });

  it('should display available exercises in dropdown', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    
    expect(screen.getByText('Push-up')).toBeInTheDocument();
    expect(screen.getByText('Squat')).toBeInTheDocument();
    expect(screen.getByText('Plank')).toBeInTheDocument();
  });

  it('should allow selecting an exercise', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    expect(autocomplete).toHaveValue('Push-up');
  });

  it('should show sets input field', () => {
    render(<WorkoutPlan />);
    
    const setsInput = screen.getByLabelText(/sets/i);
    expect(setsInput).toBeInTheDocument();
    expect(setsInput).toHaveValue(3); // default value
  });

  it('should show reps input field', () => {
    render(<WorkoutPlan />);
    
    const repsInput = screen.getByLabelText(/reps/i);
    expect(repsInput).toBeInTheDocument();
    expect(repsInput).toHaveValue(10); // default value
  });

  it('should show weight input field', () => {
    render(<WorkoutPlan />);
    
    const weightInput = screen.getByLabelText(/weight/i);
    expect(weightInput).toBeInTheDocument();
    expect(weightInput).toHaveValue(0); // default value
  });

  it('should show rest time input field', () => {
    render(<WorkoutPlan />);
    
    const restInput = screen.getByLabelText(/rest/i);
    expect(restInput).toBeInTheDocument();
    expect(restInput).toHaveValue(60); // default value
  });

  it('should allow changing sets value', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const setsInput = screen.getByLabelText(/sets/i);
    await user.clear(setsInput);
    await user.type(setsInput, '5');
    
    expect(setsInput).toHaveValue(5);
  });

  it('should allow changing reps value', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const repsInput = screen.getByLabelText(/reps/i);
    await user.clear(repsInput);
    await user.type(repsInput, '15');
    
    expect(repsInput).toHaveValue(15);
  });

  it('should show "Add to Workout" button when exercise selected', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    expect(screen.getByRole('button', { name: /add to workout/i })).toBeInTheDocument();
  });

  it('should show "Start" button when exercise selected', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    expect(screen.getByRole('button', { name: /^start$/i })).toBeInTheDocument();
  });

  it('should call startExercise with correct parameters for webcam mode', async () => {
    const user = userEvent.setup();
    mockStartExercise.mockResolvedValue(undefined);
    
    render(<WorkoutPlan />);
    
    // Select exercise
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    // Set custom values
    const setsInput = screen.getByLabelText(/sets/i);
    await user.clear(setsInput);
    await user.type(setsInput, '4');
    
    const repsInput = screen.getByLabelText(/reps/i);
    await user.clear(repsInput);
    await user.type(repsInput, '12');
    
    // Start exercise
    const startButton = screen.getByRole('button', { name: /^start$/i });
    await user.click(startButton);
    
    expect(mockStartExercise).toHaveBeenCalledWith('push-up', {
      sets: 4,
      reps_per_set: 12,
      target_weight: 0,
      rest_seconds: 60,
    });
  });

  it('should call trackVideoFile for video mode', async () => {
    const user = userEvent.setup();
    const mockVideoFile = new File(['video'], 'workout.mp4', { type: 'video/mp4' });
    
    mockUseSettings.mockReturnValue({
      settings: {
        inputMode: 'video',
        showStatsOverlay: true,
        showRepQuality: false,
        soundEnabled: false,
        showAdvancedMode: false,
        clientSideProcessing: true,
      },
      updateSetting: vi.fn(),
    });

    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      selectedVideoFile: mockVideoFile,
    });
    
    render(<WorkoutPlan />);
    
    // Select exercise and start
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    const startButton = screen.getByRole('button', { name: /^start$/i });
    await user.click(startButton);
    
    expect(mockTrackVideoFile).toHaveBeenCalledWith(mockVideoFile, 'push-up', expect.any(Object));
  });

  it('should add exercise to building workout', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    // Select exercise
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    // Add to workout
    const addButton = screen.getByRole('button', { name: /add to workout/i });
    await user.click(addButton);
    
    // Should show in building workout list
    expect(screen.getByText(/push-up/i)).toBeInTheDocument();
  });

  it('should reset form after adding to workout', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    // Select exercise and modify values
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    const setsInput = screen.getByLabelText(/sets/i);
    await user.clear(setsInput);
    await user.type(setsInput, '5');
    
    // Add to workout
    const addButton = screen.getByRole('button', { name: /add to workout/i });
    await user.click(addButton);
    
    // Form should reset
    expect(autocomplete).toHaveValue('');
    expect(setsInput).toHaveValue(3); // back to default
  });

  it('should show "Create Workout" button when exercises added', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    // Add an exercise
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    const addButton = screen.getByRole('button', { name: /add to workout/i });
    await user.click(addButton);
    
    expect(screen.getByRole('button', { name: /create workout/i })).toBeInTheDocument();
  });

  it('should allow removing exercise from building workout', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    // Add exercise
    const autocomplete = screen.getByRole('combobox');
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    
    const addButton = screen.getByRole('button', { name: /add to workout/i });
    await user.click(addButton);
    
    // Remove it
    const deleteButton = screen.getByTestId('DeleteIcon').closest('button');
    if (deleteButton) {
      await user.click(deleteButton);
    }
    
    expect(screen.queryByText(/1\.\s*push-up/i)).not.toBeInTheDocument();
  });

  it('should call setMultipleExercisesToWorkoutPlan when creating workout', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    // Add exercises
    const autocomplete = screen.getByRole('combobox');
    
    await user.click(autocomplete);
    await user.click(screen.getByText('Push-up'));
    await user.click(screen.getByRole('button', { name: /add to workout/i }));
    
    await user.click(autocomplete);
    await user.click(screen.getByText('Squat'));
    await user.click(screen.getByRole('button', { name: /add to workout/i }));
    
    // Create workout
    const createButton = screen.getByRole('button', { name: /create workout/i });
    await user.click(createButton);
    
    expect(mockSetMultipleExercisesToWorkoutPlan).toHaveBeenCalledWith(
      expect.arrayContaining([
        expect.objectContaining({ exerciseId: 'push-up' }),
        expect.objectContaining({ exerciseId: 'squat' }),
      ])
    );
  });

  it('should show stop button when exercise is tracking', () => {
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      isTracking: true,
      currentExercise: mockExercises[0],
    });
    
    render(<WorkoutPlan />);
    
    expect(screen.getByRole('button', { name: /stop/i })).toBeInTheDocument();
  });

  it('should call stopExercise when stop button clicked', async () => {
    const user = userEvent.setup();
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      isTracking: true,
      currentExercise: mockExercises[0],
    });
    
    render(<WorkoutPlan />);
    
    const stopButton = screen.getByRole('button', { name: /stop/i });
    await user.click(stopButton);
    
    expect(mockStopExercise).toHaveBeenCalled();
  });

  it('should display workout plan when exercises added', () => {
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      workoutPlan: [
        { exerciseId: 'push-up', options: { sets: 3, reps_per_set: 10 } },
        { exerciseId: 'squat', options: { sets: 3, reps_per_set: 15 } },
      ],
    });
    
    render(<WorkoutPlan />);
    
    expect(screen.getByText(/push-up/i)).toBeInTheDocument();
    expect(screen.getByText(/squat/i)).toBeInTheDocument();
  });

  it('should show completed exercises with checkmark', () => {
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      workoutPlan: [
        { exerciseId: 'push-up', options: { sets: 3, reps_per_set: 10 } },
        { exerciseId: 'squat', options: { sets: 3, reps_per_set: 15 } },
      ],
      completedExercises: ['push-up'],
    });
    
    render(<WorkoutPlan />);
    
    expect(screen.getByTestId('CheckCircleIcon')).toBeInTheDocument();
  });

  it('should allow clearing workout plan', async () => {
    const user = userEvent.setup();
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      workoutPlan: [
        { exerciseId: 'push-up', options: { sets: 3, reps_per_set: 10 } },
      ],
    });
    
    render(<WorkoutPlan />);
    
    const clearButton = screen.getByRole('button', { name: /clear workout/i });
    await user.click(clearButton);
    
    expect(mockClearWorkoutPlan).toHaveBeenCalled();
  });

  it('should allow removing individual exercise from workout plan', async () => {
    const user = userEvent.setup();
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      workoutPlan: [
        { exerciseId: 'push-up', options: { sets: 3, reps_per_set: 10 } },
      ],
    });
    
    render(<WorkoutPlan />);
    
    const deleteButton = screen.getByTestId('DeleteIcon').closest('button');
    if (deleteButton) {
      await user.click(deleteButton);
    }
    
    expect(mockRemoveExerciseFromPlan).toHaveBeenCalledWith(0);
  });

  it('should show progress indicator when loading', () => {
    mockUseWorkout.mockReturnValue({
      ...mockUseWorkout(),
      loading: true,
    });
    
    render(<WorkoutPlan />);
    
    expect(screen.getByRole('progressbar')).toBeInTheDocument();
  });

  it('should expand and collapse accordion', async () => {
    const user = userEvent.setup();
    render(<WorkoutPlan />);
    
    const accordionButton = screen.getByRole('button', { name: /workout plan/i });
    
    // Should be expanded by default
    expect(screen.getByRole('combobox')).toBeVisible();
    
    // Collapse
    await user.click(accordionButton);
    expect(screen.getByRole('combobox')).not.toBeVisible();
    
    // Expand again
    await user.click(accordionButton);
    expect(screen.getByRole('combobox')).toBeVisible();
  });
});
