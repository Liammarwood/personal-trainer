import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import SettingsMenu from '../SettingsMenu';
import { SettingsProvider } from '../../context/SettingsContext';
import { WorkoutProvider } from '../../context/WorkoutContext';

// Mock dependencies
vi.mock('../../services/api', () => ({
  default: {
    getExercisesV2: vi.fn(() => Promise.resolve({ exercises: [] })),
  },
}));

const MockProviders = ({ children }: { children: React.ReactNode }) => (
  <SettingsProvider>
    <WorkoutProvider>{children}</WorkoutProvider>
  </SettingsProvider>
);

describe('SettingsMenu', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('should render settings button', () => {
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    const settingsButton = screen.getByRole('button');
    expect(settingsButton).toBeInTheDocument();
  });

  it('should open menu when button clicked', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    const settingsButton = screen.getByRole('button');
    await user.click(settingsButton);
    
    expect(screen.getByText('Input Source')).toBeInTheDocument();
    expect(screen.getByText('Display Settings')).toBeInTheDocument();
    expect(screen.getByText('Audio Settings')).toBeInTheDocument();
  });

  it('should display all settings options', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    expect(screen.getByText('Show Stats Overlay')).toBeInTheDocument();
    expect(screen.getByText('Show Rep Quality')).toBeInTheDocument();
    expect(screen.getByText('Advanced Mode')).toBeInTheDocument();
    expect(screen.getByText('Sound Effects')).toBeInTheDocument();
  });

  it('should toggle input mode', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    const videoButton = screen.getByRole('button', { name: /video file/i });
    await user.click(videoButton);
    
    // Check that video file mode is selected
    expect(videoButton).toHaveAttribute('aria-pressed', 'true');
  });

  it('should show video file upload when video mode selected', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    const videoButton = screen.getByRole('button', { name: /video file/i });
    await user.click(videoButton);
    
    expect(screen.getByRole('button', { name: /choose video/i })).toBeInTheDocument();
  });

  it('should toggle stats overlay setting', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    const statsToggle = screen.getByRole('checkbox', { name: /show stats overlay/i });
    expect(statsToggle).toBeChecked(); // Default is true
    
    await user.click(statsToggle);
    expect(statsToggle).not.toBeChecked();
  });

  it('should toggle sound setting', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    const soundToggle = screen.getByRole('checkbox', { name: /sound effects/i });
    expect(soundToggle).not.toBeChecked(); // Default is false
    
    await user.click(soundToggle);
    expect(soundToggle).toBeChecked();
  });

  it('should toggle advanced mode setting', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    
    const advancedToggle = screen.getByRole('checkbox', { name: /advanced mode/i });
    expect(advancedToggle).not.toBeChecked();
    
    await user.click(advancedToggle);
    expect(advancedToggle).toBeChecked();
  });

  it('should persist settings when changed', async () => {
    const user = userEvent.setup();
    render(
      <MockProviders>
        <SettingsMenu />
      </MockProviders>
    );
    
    await user.click(screen.getByRole('button'));
    await user.click(screen.getByRole('checkbox', { name: /sound effects/i }));
    
    const saved = JSON.parse(localStorage.getItem('workout-settings') || '{}');
    expect(saved.soundEnabled).toBe(true);
  });
});
