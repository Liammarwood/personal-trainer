import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import WorkoutStatsOverlay from '../WorkoutStatsOverlay';
import type { WorkoutStats } from '../../types';
import MockProviders from '../../test/MockProviders';

describe('WorkoutStatsOverlay', () => {
  const mockStats: WorkoutStats = {
    reps: 8,
    sets: 2,
    duration: 60,
    expected_plan: {
      sets: 3,
      reps_per_set: 10,
      target_weight: 15,
      rest_seconds: 60,
    },
    rep_quality: 'Good form',
    in_rest_period: false,
    rest_remaining: 0,
    joint_angles: {
      'left_elbow': 145,
      'right_elbow': 142,
      'left_knee': 170,
    },
  };

  it('should render when visible is true', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText('Workout Progress')).toBeInTheDocument();
  });

  it('should not render stats panel when visible is false', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={false} />
      </MockProviders>
    );
    
    expect(screen.queryByText('Workout Progress')).not.toBeInTheDocument();
  });

  it('should display current reps and sets', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText(/8/)).toBeInTheDocument(); // reps
    expect(screen.getByText(/Set 2/)).toBeInTheDocument();
  });

  it('should display expected plan', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText(/\/ 3/)).toBeInTheDocument(); // total sets
    expect(screen.getByText(/\/ 10/)).toBeInTheDocument(); // reps per set
  });

  it('should display target weight when available', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText(/15 kg/)).toBeInTheDocument();
  });

  it('should display duration', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText(/1:00/)).toBeInTheDocument(); // 60 seconds = 1:00
  });

  it('should display rest timer when in rest period', () => {
    const restStats: WorkoutStats = {
      ...mockStats,
      in_rest_period: true,
      rest_remaining: 45,
    };

    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={restStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText(/45s/)).toBeInTheDocument();
    expect(screen.getByText(/Rest Period/i)).toBeInTheDocument();
  });

  it('should display rep quality feedback', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText('Good form')).toBeInTheDocument();
  });

  it('should display joint angles in advanced mode', () => {
    // This would require passing advanced mode setting
    // For now, just check the structure exists
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    // Component should have the ability to show joint angles
    expect(screen.getByText('Workout Progress')).toBeInTheDocument();
  });

  it('should calculate progress percentage', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={mockStats} visible={true} />
      </MockProviders>
    );
    
    // 2 sets complete (20 reps) + 8 current reps = 28 / 30 total = 93%
    expect(screen.getByText(/Progress/i)).toBeInTheDocument();
  });

  it('should handle stats without expected plan', () => {
    const statsWithoutPlan: WorkoutStats = {
      reps: 10,
      sets: 3,
      duration: 120,
    };

    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={statsWithoutPlan} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText('Workout Progress')).toBeInTheDocument();
    expect(screen.getByText(/Set 1/)).toBeInTheDocument();
  });

  it('should display current instruction when available', () => {
    const statsWithInstruction: WorkoutStats = {
      ...mockStats,
      current_instruction: 'Keep your back straight',
    };

    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={statsWithInstruction} visible={true} />
      </MockProviders>
    );
    
    expect(screen.getByText('Keep your back straight')).toBeInTheDocument();
  });

  it('should not render stats when stats is null', () => {
    render(
      <MockProviders>
        <WorkoutStatsOverlay stats={null} visible={true} />
      </MockProviders>
    );
    
    expect(screen.queryByText('Workout Progress')).not.toBeInTheDocument();
  });
});
